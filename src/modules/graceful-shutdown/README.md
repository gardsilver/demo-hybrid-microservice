# Graceful Shutdown Module

### Описание
Данный модуль запускает процесс плавного завершения приложения при получении сигнала **SIGTERM** (**@see** `GRACEFUL_SHUTDOWN_DESTROY_SIGNAL`).

`UncaughtExceptionFilter` добавляет обработчики событий `uncaughtException` и `uncaughtRejection`, которые фиксируют логи и метрики о возникновении не обработанных ошибок и посылают сигнал **SIGTERM** (**@see** `GRACEFUL_SHUTDOWN_DESTROY_SIGNAL`), тем самым запуская процесс плавного завершения приложения.

## Важно!
Для корректной работы модуля необходимо вызвать `app.enableShutdownHooks()` на старте приложения.

### Принцип работы `UncaughtExceptionFilter`
При получении события `uncaughtException` или `uncaughtRejection` запускается процесс плавного завершения приложения:
1. Пишется лог о возникновении непредвиденной ошибки.
2. Регистрируются соответствующие метрики
 - `UNCAUGHT_EXCEPTION_COUNT`
 - `UNCAUGHT_REJECTION_COUNT`
3. Отправляется сигнал **SIGTERM** (**@see** `GRACEFUL_SHUTDOWN_DESTROY_SIGNAL`), начинается [процесс завершения приложения](https://docs.nestjs.com/fundamentals/lifecycle-events#application-shutdown)

### Декоратор метода `GracefulShutdownOnCount`
  Декорируемый метод будет учитываться счетчиком активных процессов **@see** `ACTIVE_METHODS_GAUGE`.

  Имейте ввиду, что данный метод не имеет возможности учитывать моменты завершения запущенных асинхронных под-процессов. Если логика требует запуска асинхронных под-процессов, которые также важные при подсчете количества активных процессов, следует к таким под-процессам дополнительно добавлять данный декоратор.

#### ВАЖНО
Декоратор метода `GracefulShutdownOnCount` переопределяет декорируемый метод. Если вы применяете этот декоратор в сочетании с другими декораторами, активно использующие метаданные, то могут быть скрытые ошибки из-за потери метаданных последними.
При возникновении подобной проблемы помогает:
  - смена порядка применения декораторов 
  - или применение конфликтующих декораторов на разные методы.

### Декоратор метода `GracefulShutdownOnEvent`
  Декорируемый метод будет вызван при возникновении соответствующего события: 
   - `GracefulShutdownEvents.BEFORE_DESTROY`
   - `GracefulShutdownEvents.AFTER_DESTROY`.

### ВАЖНО
  Декораторы требуют инициализации, а значит они должны быть применены на методы, которые будут использоваться после успешной инициализации `GracefulShutdownModule`.
  Аналогично, события `uncaughtException` и `uncaughtRejection` будут обрабатываться только после успешной инициализации модуля.

### Принцип работы `GracefulShutdownService`

1. При получении сигнала **SIGTERM** (**@see** `GRACEFUL_SHUTDOWN_DESTROY_SIGNAL`) срабатывает хук lifecycle hook `beforeApplicationShutdown`.

2. Запускаются обработчики события `GracefulShutdownEvents.BEFORE_DESTROY`.

Такие обработчики, например, могут закрыть консьюмеры очередей или отключить крон-процессы.

По завершении работы обработчиков данного события, не должны появляться новые активные процессы (**@see** `GracefulShutdownOnCount`).

Если обработчики не успеют завершиться за `GRACEFUL_SHUTDOWN_TIMEOUT_ON_BEFORE_DESTROY` mc будет выброшена ошибка `TimeoutError` и процесс плавного завершения приложения будет прерван.

3. Ожидает пока счетчик активных процессов не станет равным **0**.

Что бы метод учитывался счетчиком активных процессов, к нему нужно добавить декоратор `GracefulShutdownOnCount`.

Все активные процессы должны завершиться не более чем за `GRACEFUL_SHUTDOWN_TIMEOUT_ON_DESTROY` mc. В противном случает будет выброшена ошибка `TimeoutError` и процесс плавного завершения приложения будет прерван.

4. Запускаются обработчики события `GracefulShutdownEvents.AFTER_DESTROY`.

Если обработчики не успеют завершиться за `GRACEFUL_SHUTDOWN_TIMEOUT_ON_AFTER_DESTROY` mc будет выброшена ошибка `TimeoutError` и процесс плавного завершения приложения будет прерван.

5. Не зависимо от того, как завершатся предыдущие этапы (успешно или нет) приложение будет ожидать дополнительные `GRACEFUL_SHUTDOWN_GRACE_PERIOD` mc. Нужно что бы сборщики логов/метрик смогли забрать всю зафиксированную информацию о процессе плавного завершения приложения.

## ВАЖНО
Из-за внутренних ограничений платформы, **NestJS** имеет ограниченную поддержку хуков завершения приложений в **Windows**
[@see](https://docs.nestjs.com/fundamentals/lifecycle-events#application-shutdown). В частности **SIGTERM** (**@see** `GRACEFUL_SHUTDOWN_DESTROY_SIGNAL`) никогда не будет работать в **Windows**.

### Параметры окружения
| Параметры окружения (**env**)| Обязательный | Возможные значения | Описание|
|---|---|---|---|
|`GRACEFUL_SHUTDOWN_ENABLED`|нет. По умолчанию: **yes** | Строка: **yes** или **no** (без учета регистра) | Позволяет включать/отключать процесс плавного завершения приложения. |
|`GRACEFUL_SHUTDOWN_TIMEOUT_ON_BEFORE_DESTROY`|нет. По умолчанию: **10_000** | Целое число в миллисекундах | Задает максимальное время выполнения этапа **Before Destroy**. |
|`GRACEFUL_SHUTDOWN_TIMEOUT_ON_DESTROY`|нет. По умолчанию: **30_000** | Целое число в миллисекундах | Задает максимальное время выполнения этапа **Destroy**. |
|`GRACEFUL_SHUTDOWN_TIMEOUT_ON_AFTER_DESTROY`|нет. По умолчанию: **10_000** | Целое число в миллисекундах | Задает максимальное время выполнения этапа **After Destroy**. |
|`GRACEFUL_SHUTDOWN_GRACE_PERIOD`|нет. По умолчанию: **15_000** | Целое число в миллисекундах | Задает время ожидания перед завершение работы приложения. |
|`GRACEFUL_SHUTDOWN_DESTROY_SIGNAL`|нет. По умолчанию: **SIGTERM** | Тип сигнала завершения приложения | При получении данного сигнала будет запущен процесс плавного завершения приложения. |

### Метрики
| Метрика| Метки |Описание|
|---|---|---|
|`UNCAUGHT_EXCEPTION_COUNT`|**labelNames** `['type', 'module', 'file']`| Счетчик количества не обработанных ошибок|
|`UNCAUGHT_REJECTION_COUNT`|**labelNames** `['reason', 'type', 'module', 'file']`| Счетчик количества не обработанных Promise rejections|
|`GRACEFUL_SHUTDOWN_DURATIONS`|**labelNames** `['service', 'signal']`| Гистограмма длительности плавного завершения приложения|
|`GRACEFUL_SHUTDOWN_FAILED`|**labelNames** `['service', 'signal']`| Количество не удачных завершений работы приложения|
|`ACTIVE_METHODS_GAUGE`|**labelNames** `['service', 'method']`| Счетчик количества активных процессов|
|`ACTIVE_METHODS_DURATIONS`|**labelNames** `['service', 'method']`| Гистограмма длительности выполнения активных процессов|
|`ACTIVE_METHODS_FAILED`|**labelNames** `['service', 'method']`| Количество активных процессов завершенных с ошибкой |
